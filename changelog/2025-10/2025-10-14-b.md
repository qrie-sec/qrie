# Changes Summary - UI Logging and Deployment Fixes

## Overview
Fixed UI deployment process to automatically use correct API URLs and integrated cache invalidation. Renamed monitoring script to focus on Lambda logs (not UI logs).

## Files Modified

### 1. `/qop.py` - Enhanced deployment automation
**Changes:**
- **Enhanced `_run_command()` method**: Added optional `env` parameter for custom environment variables
- **Fixed `deploy_ui()` method**: 
  - Properly passes `NEXT_PUBLIC_API_BASE_URL` as environment variable to npm build
  - Temporarily renames `.env.local` during build to prevent override
  - **NEW**: Integrated CloudFront cache invalidation automatically
  - **NEW**: Added user-friendly cache invalidation messaging
- **Result**: `./qop.py --deploy-ui` now fully automated - no manual `.env.local` changes needed

### 2. `/qrie-infra/lambda/api/api_handler.py` - Fixed CORS issues
**Changes:**
- **Removed duplicate CORS headers**: Lambda Function URL already handles CORS
- **Before**: Both Function URL and application code set `Access-Control-Allow-Origin`
- **After**: Only Function URL sets CORS headers (prevents "multiple values" error)
- **Result**: Fixed CORS policy errors in browser

### 3. `/qrie-ui/.env.local` - Development-focused configuration
**Changes:**
- **Updated for local development**: Now defaults to `http://localhost:3001/api`
- **Added clear documentation**: Explains deployment behavior and temporary file handling
- **Result**: Clear separation between dev and production configurations

### 4. `/tools/debug/monitor-lambda-logs.sh` - Renamed and enhanced
**Changes:**
- **Renamed**: From `monitor-ui-logs.sh` to `monitor-lambda-logs.sh` (UI logs are in browser, not server)
- **Enhanced**: Now monitors all Lambda functions:
  - API Handler logs
  - Policy Scanner logs  
  - Event Processor logs
  - Inventory Generator logs
- **Result**: Comprehensive Lambda monitoring tool

## Files Removed

### 1. `/tools/debug/invalidate-cache.sh` - DELETED
**Reason**: Cache invalidation now integrated into `deploy-ui` process
**Replacement**: Automatic cache invalidation in `qop.py --deploy-ui`

### 2. `/qrie-infra/cdk.out/` - CLEANED
**Reason**: Removed outdated CDK build artifacts
**Result**: Clean build state for next deployment

## Key Improvements

### ✅ Automated Deployment
- **Before**: Manual `.env.local` editing required
- **After**: Fully automated API URL detection and usage

### ✅ Fixed CORS Issues  
- **Before**: "Multiple Access-Control-Allow-Origin values" error
- **After**: Clean CORS handling via Lambda Function URL

### ✅ Integrated Cache Management
- **Before**: Separate script for cache invalidation
- **After**: Automatic cache invalidation during deployment

### ✅ Better Monitoring
- **Before**: Confusing "UI logs" script (UI logs are in browser)
- **After**: Clear "Lambda logs" script for server-side monitoring

## Testing Verification

### API Connectivity ✅
```bash
curl -v -H "Origin: https://dl4udjctraejl.cloudfront.net" \
  "https://nedndshditvthffqpw2bo6lllm0aybnv.lambda-url.us-east-1.on.aws/findings"
# Result: Single Access-Control-Allow-Origin header, no CORS errors
```

### Build Output ✅
```bash
grep -r "nedndshditvthffqpw2bo6lllm0aybnv" qrie-ui/out/
# Result: Correct us-east-1 API URL found in build output
```

### Cache Invalidation ✅
```bash
./qop.py --deploy-ui --region us-east-1 --profile qop
# Result: Automatic cache invalidation with user guidance
```

## Commit-Ready Status

### ✅ All Changes Verified
- [x] API URL automation working
- [x] CORS issues resolved  
- [x] Cache invalidation integrated
- [x] Monitoring script renamed and enhanced
- [x] Unnecessary files removed
- [x] CDK artifacts cleaned

### ✅ No Breaking Changes
- [x] Backward compatible
- [x] Existing workflows preserved
- [x] Clear user messaging

### ✅ Documentation Updated
- [x] `.env.local` has clear comments
- [x] Script names reflect actual purpose
- [x] User guidance in deployment output

## Recommended Commit Message
```
fix: automate UI deployment with correct API URLs and cache invalidation

- Enhanced deploy-ui to automatically use API URL from stack outputs
- Fixed CORS issues by removing duplicate headers
- Integrated CloudFront cache invalidation into deployment process
- Renamed monitoring script to focus on Lambda logs (UI logs are in browser)
- Cleaned up temporary scripts and build artifacts

Resolves: UI showing test data instead of real API data
Resolves: CORS "multiple values" errors
Resolves: Manual .env.local editing requirement
```
