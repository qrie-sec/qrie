# Changelog - October 16, 2025

## üöÄ New Features

### Policy Launch and Update APIs
- **POST /policies/launch**: Launch policies with custom scope configuration
  - Supports account filtering (include/exclude)
  - Tag-based targeting with arrays of values
  - OU path filtering for Organizations
  - Optional severity and remediation overrides
  - Triggers automatic full scan after launch
  
- **PUT /policies/update**: Update existing launched policies
  - Update scope configuration
  - Change policy status (active/suspended)
  - Override severity and remediation
  - Triggers re-scan of affected resources

### Policy Management UI
- **Launch Policy Dialog**: Full-featured UI for launching policies
  - Scope mode selector (all accounts vs. custom)
  - Account selection with multi-select
  - Tag filtering configuration
  - OU path targeting
  - Severity slider (0-100)
  - Remediation text editor with 15-line textarea
  - Loading states with spinner animations
  - Error display with request ID correlation

- **Edit Policy Dialog**: Update launched policy configurations
  - All launch dialog features
  - "Disable Policy" button to suspend policies
  - Automatic data refresh after changes
  - Error handling with request ID display

### Request Correlation and Logging
- **Lambda Request ID Logging**: All API requests now log with AWS request ID
  - Format: `[abc123-def456-789ghi] POST /policies/launch`
  - Enables correlation between UI errors and Lambda logs
  - Request ID displayed in UI error messages

- **Detailed Policy Operation Logging**:
  - Launch operations: `Launch policy request: policy_id=IAMAccessKeyNotRotated`
  - Update operations: `Updating policy IAMAccessKeyNotRotated with 3 changes`
  - Success confirmations: `Successfully launched policy IAMAccessKeyNotRotated`
  - Policy ID included in all error messages

### Enhanced Log Monitoring
- **Color-Coded Log Script**: `tools/debug/monitor-lambda-logs.sh`
  - DEBUG: Dark gray
  - INFO: Light gray
  - WARN: Yellow
  - ERROR: Red
  - FATAL: Magenta
  - Real-time log tailing with `--follow`
  - Accepts region and profile as arguments (defaults: us-east-1, qop)
  - Simplified from complex multi-function script to focused log viewer

## üèóÔ∏è Infrastructure Changes

### Backend API Handlers
- **policies_api.py**: Added `handle_launch_policy()` and `handle_update_policy()`
  - JSON body parsing with validation
  - Scope configuration parsing
  - Error handling with proper HTTP status codes (400, 404, 500)
  - Full stack traces on errors

- **api_handler.py**: Added routing for new endpoints
  - `POST /policies/launch` ‚Üí `handle_launch_policy()`
  - `PUT /policies/update` ‚Üí `handle_update_policy()`
  - Request ID logging on all requests
  - Request ID in error logs

### Data Access Layer
- **policy_manager.py**: Enhanced with launch and update operations
  - `launch_policy()`: Create launched policy in DynamoDB
  - `update_launched_policy()`: Update existing policy configuration
  - Scope validation and conversion
  - Atomic updates with proper error handling

## üîß Developer Experience

### Frontend API Client
- **api.ts**: Added `launchPolicy()` and `updatePolicy()` functions
  - Proper error handling with request ID extraction
  - Response header parsing for correlation
  - Demo mode removed (all test data fallbacks removed)
  - Consistent error format: `{ success: boolean, error?: string, requestId?: string }`

### Error Handling Improvements
- **UI Error Display**: Request IDs shown in error messages
  - Format: "Failed to launch policy\nRequest Id: abc123-def456"
  - Helps developers correlate UI errors with Lambda logs
  - Displayed in red error banners in dialogs

- **API Error Handler**: Centralized error handling in `api.ts`
  - Extracts request ID from response headers
  - Parses error messages from JSON responses
  - Fallback to status text for non-JSON errors
  - Returns structured `ApiError` interface

### Monitoring Tools
- **Simplified Log Monitoring**: Removed hardcoded values from monitor script
  - No more hardcoded API URLs, distribution IDs, or account numbers
  - Clean, focused script that just tails logs
  - Easy to use: `./tools/debug/monitor-lambda-logs.sh [region] [profile]`

## üêõ Bug Fixes

### Lambda Context Attribute
- **Fixed**: `AttributeError: 'LambdaContext' object has no attribute 'request_id'`
  - Changed from `context.request_id` to `context.aws_request_id`
  - Applied fix in both main handler and exception handler
  - Proper fallback to "unknown" when context is None

### UI Type Safety
- **Fixed**: TypeScript errors in management view
  - Added proper error state management
  - Type-safe error handling with optional request IDs
  - Proper loading state management during API calls

## üìö Documentation Updates

### API Documentation
- **qrie_apis.md**: Added comprehensive documentation for new endpoints
  - POST /policies/launch with full request/response examples
  - PUT /policies/update with all update scenarios
  - Error codes and status explanations
  - Notes about automatic scan triggering

### README Updates
- **Main README.md**: Enhanced monitoring section
  - Color-coded log monitoring script usage
  - Request correlation explanation
  - New POST/PUT endpoints in test list
  - Improved AWS CLI commands with parameters

- **qrie-infra/README.md**: Enhanced monitoring documentation
  - Color-coded log levels documented
  - Request correlation patterns with examples
  - Policy operation logging patterns
  - Reference to qop.py --info command

## üîÑ Maintenance

### Code Cleanup
- **Removed Demo Mode**: Eliminated all test data fallbacks from api.ts
  - Removed 250+ lines of test data constants
  - Removed isDemoMode() checks throughout
  - Removed setDemoMode() function
  - All APIs now fail fast instead of returning fake data

- **Improved Code Organization**:
  - Separated error handling into dedicated function
  - Consistent error response format across all APIs
  - Proper TypeScript interfaces for error types

### UI Improvements
- **Dialog Sizing**: Increased launch/edit dialog width from 3xl to 4xl
  - Better visibility for scope configuration
  - More comfortable editing experience

- **Error Display**: Consistent error formatting
  - Red background with border
  - Request ID in italic small text
  - Clear visual hierarchy

## Technical Details

### Files Modified
**Backend**:
- `qrie-infra/lambda/api/api_handler.py` - Request ID logging, new route handlers
- `qrie-infra/lambda/api/policies_api.py` - Launch and update handlers
- `qrie-infra/lambda/data_access/policy_manager.py` - Launch and update operations

**Frontend**:
- `qrie-ui/lib/api.ts` - Launch/update functions, error handling, demo mode removal
- `qrie-ui/components/management-view.tsx` - Launch/edit dialogs, error states

**Tools**:
- `tools/debug/monitor-lambda-logs.sh` - Color coding, simplified logic

**Documentation**:
- `qrie-infra/qrie_apis.md` - New endpoint documentation
- `README.md` - Monitoring improvements
- `qrie-infra/README.md` - Request correlation patterns

### API Request/Response Examples

**Launch Policy**:
```bash
curl -X POST https://api.example.com/policies/launch \
  -H "Content-Type: application/json" \
  -d '{
    "policy_id": "S3BucketPublic",
    "scope": {
      "include_accounts": ["123456789012"],
      "exclude_accounts": [],
      "include_tags": {"Environment": ["prod"]},
      "exclude_tags": {},
      "include_ou_paths": [],
      "exclude_ou_paths": []
    },
    "severity": 90,
    "remediation": "Remove public access"
  }'
```

**Update Policy**:
```bash
curl -X PUT https://api.example.com/policies/update \
  -H "Content-Type: application/json" \
  -d '{
    "policy_id": "S3BucketPublic",
    "status": "suspended"
  }'
```

### Log Correlation Example

**UI Console**:
```
[v0 API] ‚ùå POST /policies/launch {"params":{"policyId":"IAMAccessKeyNotRotated"},"error":{"message":"Failed to launch policy","requestId":"abc123-def456"}}
```

**Lambda Logs**:
```
[abc123-def456] POST /policies/launch
Launch policy request: policy_id=IAMAccessKeyNotRotated
Launching policy IAMAccessKeyNotRotated with severity=70, scope=0 accounts
Error launching policy IAMAccessKeyNotRotated: Policy definition not found
Traceback (most recent call last):
  ...
```

## Next Steps

- Deploy updated Lambda code: `./qop.py --deploy-core --region us-east-1 --profile qop`
- Deploy updated UI: `./qop.py --deploy-ui --region us-east-1 --profile qop`
- Test policy launch and update functionality
- Monitor logs with color-coded script: `./tools/debug/monitor-lambda-logs.sh`
